dist: ../dist-pach/docker

builds:
  -
    id: pachd
    dir: src/server/cmd/pachd
    main: main.go
    binary: pachd
    env:
      - CGO_ENABLED=0
    ldflags:
      - "{{ .Env.LD_FLAGS }}"
    goos:
      - linux
    goarch:
      - arm64
      - amd64
  -
    id: worker
    dir: src/server/cmd/worker
    main: main.go
    binary: worker
    env:
      - CGO_ENABLED=0
    ldflags:
      - "{{ .Env.LD_FLAGS }}"
    goos:
      - linux
    goarch:
      - arm64
      - amd64
  -
    id: worker_init
    dir: etc/worker
    main: init.go
    binary: worker_init
    env:
      - CGO_ENABLED=0
    ldflags:
      - "{{ .Env.LD_FLAGS }}"
    goos:
      - linux
    goarch:
      - arm64
      - amd64
  -
    id: pachctl
    dir: src/server/cmd/pachctl
    main: main.go
    binary: pachctl
    ldflags:
      - "{{ .Env.LD_FLAGS }}"
    goos:
      - linux
    goarch:
      - arm64
      - amd64
  -
    id: pachtf
    dir: src/server/cmd/pachtf
    main: main.go
    binary: pachtf
    env:
      - CGO_ENABLED=0
    ldflags:
      - "{{ .Env.LD_FLAGS }}"
    goos:
      - linux
    goarch:
      - arm64
      - amd64

archives:
  - format: binary
    builds:
      - pachctl

checksum:
  disable: true

changelog:
  skip: true

release:
  disable: true

dockers:
  -
    image_templates:
      - pachyderm/pachd-amd64:latest
      - pachyderm/pachd-amd64:local
    use: buildx
    ids:
      - pachd
    goarch: amd64
    skip_push: false
    dockerfile: Dockerfile.pachd
    extra_files:
      - dex-assets
      - LICENSE
      - licenses
    build_flag_templates:
      - "--label=version={{.Version}}"
      - "--label=release={{.Version}}"
      - "--platform=linux/amd64"
  -
    image_templates:
      - pachyderm/pachd-arm64:latest
      - pachyderm/pachd-arm64:local
    use: buildx
    ids:
      - pachd
    goarch: arm64
    skip_push: false
    dockerfile: Dockerfile.pachd
    extra_files:
      - dex-assets
      - LICENSE
      - licenses
    build_flag_templates:
      - "--label=version={{.Version}}"
      - "--label=release={{.Version}}"
      - "--platform=linux/arm64"
  -
    image_templates:
      - pachyderm/pachctl-amd64:latest
    use: buildx
    ids:
      - pachctl
    goarch: amd64
    skip_push: false
    dockerfile: Dockerfile.pachctl
    build_flag_templates:
      - "--progress=plain"
      - "--label=version={{.Version}}"
      - "--label=release={{.Version}}"
      - "--platform=linux/amd64"
    extra_files:
      - LICENSE
      - licenses
  -
    image_templates:
      - pachyderm/pachctl-arm64:latest
    use: buildx
    ids:
      - pachctl
    goarch: arm64
    skip_push: false
    dockerfile: Dockerfile.pachctl
    build_flag_templates:
      - "--progress=plain"
      - "--label=version={{.Version}}"
      - "--label=release={{.Version}}"
      - "--platform=linux/arm64"
    extra_files:
      - LICENSE
      - licenses
  -
    image_templates:
      - pachyderm/worker-amd64:latest
      - pachyderm/worker-amd64:local
    use: buildx
    ids:
      - pachctl
      - worker_init
      - worker
    goarch: amd64
    skip_push: false
    dockerfile: Dockerfile.worker
    build_flag_templates:
      - "--progress=plain"
      - "--label=version={{.Version}}"
      - "--label=release={{.Version}}"
      - "--platform=linux/amd64"
    extra_files:
      - LICENSE
      - licenses
  -
    image_templates:
      - pachyderm/worker-arm64:latest
      - pachyderm/worker-arm64:local
    use: buildx
    ids:
      - pachctl
      - worker_init
      - worker
    goarch: arm64
    skip_push: false
    dockerfile: Dockerfile.worker
    build_flag_templates:
      - "--progress=plain"
      - "--label=version={{.Version}}"
      - "--label=release={{.Version}}"
      - "--platform=linux/arm64"
    extra_files:
      - LICENSE
      - licenses
  -
    image_templates:
      - pachyderm/pachtf-amd64:latest
    use: buildx
    ids:
      - pachtf
    goarch: amd64
    skip_push: false
    dockerfile: Dockerfile.pachtf
    build_flag_templates:
      - "--progress=plain"
      - "--label=version={{.Version}}"
      - "--label=release={{.Version}}"
      - "--platform=linux/amd64"
    extra_files:
      - LICENSE
      - licenses
  -
    image_templates:
      - pachyderm/pachtf-arm64:latest
    use: buildx
    ids:
      - pachtf
    goarch: arm64
    skip_push: false
    dockerfile: Dockerfile.pachtf
    build_flag_templates:
      - "--progress=plain"
      - "--label=version={{.Version}}"
      - "--label=release={{.Version}}"
      - "--platform=linux/arm64"
    extra_files:
      - LICENSE
      - licenses

docker_manifests:
  -
    name_template: pachyderm/pachd:latest
    skip_push: false
    image_templates:
      - pachyderm/pachd-amd64:latest
      - pachyderm/pachd-arm64:latest
  -
    name_template: pachyderm/pachctl:latest
    skip_push: false
    image_templates:
      - pachyderm/pachctl-amd64:latest
      - pachyderm/pachctl-arm64:latest
  -
    name_template: pachyderm/worker:latest
    skip_push: false
    image_templates:
      - pachyderm/worker-amd64:latest
      - pachyderm/worker-arm64:latest
  -
    name_template: pachyderm/pachtf:latest
    skip_push: false
    image_templates:
      - pachyderm/pachtf-amd64:latest
      - pachyderm/pachtf-arm64:latest
